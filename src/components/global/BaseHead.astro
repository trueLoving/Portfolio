---
import '../../styles/global.css';
// @ts-expect-error - package exports named AstroSeo but types may not resolve correctly in some setups
import { AstroSeo } from '@astrolib/seo';
import { getUserConfig } from '../../config/loader';
import type { Locale } from '../../i18n/types';
import { backgroundConfig } from '../../config/background';

const locale = (Astro.props.locale as Locale | undefined) ?? 'en';
const userConfig = getUserConfig(locale);

// Build safe defaults for SEO
const siteOrigin = Astro.site ? new URL('/', Astro.site).origin : undefined;
const canonicalUrl = Astro.props.canonical || siteOrigin;
const ogUrl = Astro.props.openGraph?.url || siteOrigin;
// Use configured background as OG image if available and site is known
const ogImageUrl =
  siteOrigin && backgroundConfig.defaultOgImage
  ? new URL(backgroundConfig.defaultOgImage, siteOrigin).toString()
  : undefined;
---

<!-- Core meta tags -->
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<meta name="author" content={userConfig.name} />

<!-- SEO Configuration -->
<AstroSeo
  title={Astro.props.title || userConfig.seo.title}
  description={Astro.props.description || userConfig.seo.description}
  canonical={canonicalUrl}
  openGraph={{
    url: ogUrl,
    title: Astro.props.openGraph?.title || userConfig.seo.title,
    description: Astro.props.openGraph?.description || userConfig.seo.description,
    ...(ogImageUrl ? { images: [{ url: ogImageUrl }] } : {}),
    site_name: Astro.props.openGraph?.site_name || userConfig.name,
  }}
  twitter={{
    cardType: 'summary_large_image',
  }}
/>

<!-- JSON-LD Schema.org -->
{
  siteOrigin &&
    (() => {
      const websiteSchema = JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'WebSite',
      url: siteOrigin,
      name: userConfig.name,
      description: userConfig.seo.description,
      });
      const personSchema = JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'Person',
      name: userConfig.name,
      jobTitle: userConfig.role,
      url: siteOrigin,
      sameAs: [userConfig.social.github, userConfig.social.linkedin].filter(Boolean),
      });
      return (
        <>
          <script type="application/ld+json" set:html={websiteSchema} />
          <script type="application/ld+json" set:html={personSchema} />
        </>
      );
    })()
}

<!-- Add your favicon files in public/images/ -->
<link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico" />
<link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico" />

<!-- Theme colors for browsers -->
<meta name="msapplication-TileColor" content={userConfig.theme.secondaryColor} />
<meta name="theme-color" content={userConfig.theme.secondaryColor} />

<!-- Auto-generated sitemap -->
<link rel="sitemap" href="/sitemap-index.xml" />

<!-- Preload background images for performance -->
{
  backgroundConfig.defaultPreloadImage && (
  <link
      rel="preload"
    href={backgroundConfig.defaultPreloadImage}
      as="image"
    type={backgroundConfig.defaultPreloadImage.endsWith('.svg') ? 'image/svg+xml' : 'image/jpeg'}
      fetchpriority="high"
  />
  )
}
{
  backgroundConfig.defaultPreloadVideo && (
  <link
      rel="preload"
    href={backgroundConfig.defaultPreloadVideo}
      as="video"
      type="video/mp4"
      fetchpriority="high"
  />
  )
}
